name: Deploy CSP Sidekick (Docker Selfhosted Runner)

on:
  workflow_dispatch:
    inputs:
      deployment_type:
        description: "Deployment type"
        required: true
        default: "all"
        type: choice
        options:
          - all
          - dry-run
          - workers-only
          - sites-only

  push:
    branches: [main]
    paths-ignore:
      - "**.md"
      - ".github/**"
      - "scripts/**"
      - "README/**"

permissions:
  contents: read

env:
  NODE_VERSION: "20"
  PNPM_VERSION: "9.12.0"

jobs:
  deploy:
    name: Build and Deploy
    runs-on:
      - self-hosted
      - macos
      - docker
    environment: production

    steps:
      - name: Checkout
        uses: actions/checkout@v4


      # Run deployment directly on the self-hosted runner
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: Deploy All Projects (Dry Run)
        if: ${{ github.event.inputs.deployment_type == 'dry-run' || github.event_name == 'pull_request' }}
        run: ./scripts/deploy-all-direct.sh dry-run
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: Deploy All Projects
        if: ${{ github.event.inputs.deployment_type == 'all' || (github.event_name == 'push' && github.ref == 'refs/heads/main') }}
        run: ./scripts/deploy-all-direct.sh deploy
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: Deploy Workers Only
        if: ${{ github.event.inputs.deployment_type == 'workers-only' }}
        run: |
          pnpm run build:shared
          pnpm run build:workers
          echo "ðŸš€ Workers deployed successfully"
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: Deploy Sites Only
        if: ${{ github.event.inputs.deployment_type == 'sites-only' }}
        run: |
          pnpm run build:shared
          pnpm run build:react-apps
          pnpm run build:astro-sites
          pnpm run build:cspsidekick
          echo "ðŸš€ Sites deployed successfully"
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

  # ...existing code for summary step...

      - name: Summary
        if: always()
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Deployment Type**: ${{ github.event.inputs.deployment_type || 'auto (push to main)' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Triggered by**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… All projects deployed successfully!" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Deployment failed. Check logs above." >> $GITHUB_STEP_SUMMARY
          fi
                ORG: ${ORG}                  # Set org name when using org-level runner registration
                REG_TOKEN: ${REG_TOKEN}
                NAME: ${NAME}
                CLOUDFLARE_API_TOKEN: ${CLOUDFLARE_API_TOKEN}
                CLOUDFLARE_ACCOUNT_ID: ${CLOUDFLARE_ACCOUNT_ID}
